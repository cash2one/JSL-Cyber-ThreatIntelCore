import urllib3
import BeautifulSoup as bs
NEXT_CHECK = 1
DOMAIN = 2
TYPE = 3
REFERENCE = 4

URL = "http://www.malwaredomainlist.com/mdl.php?inactive=&sort=Date&search=&colsearch=All&ascordesc=DESC&quantity=100000&page=0"


def parse_malware_domains(url):
    '''

    :param url:
    :return a List of dictionaries with four key/value pairs : domain, type of threat, reference, next check :
    '''
    unique_types = []
    spamlist = []

    http = urllib3.PoolManager()
    doc = http.request('GET', url).data

    soup = bs.BeautifulSoup(doc)
    soup = soup.findAll('table')[1]

    for row in soup.findAll('tr'):


        aux = row.findAll('td')



        if len(aux) > 1:
            spam = {}
            spam['country'] = ''
            if aux[7].find('img'):


                spam['country'] = aux[7].find('img')['alt']

            if len( aux[2].contents[0].string.split('/')) > 1:
                spam['ip_address'] = aux[2].contents[0].string.split('/')[0]
            else:
                spam['ip_address'] = aux[2].contents[0]
            spam['listing_date'] = aux[0].contents[0].string
            spam['host_name'] = aux[1].string
            spam['autonomous_system_number'] = aux[6].string

            spam['description_text'] = aux[4].string
            spamlist.append(spam)

    return spamlist

'''
blacklist = parse_malware_domains(URL)

for element in blacklist:
    print element
'''